import eclipsebuild.*
import eclipsebuild.testing.EclipseTestTask
import org.gradle.internal.os.OperatingSystem
import java.util.regex.*

plugins {
    id "org.ajoberstar.grgit" version "4.1.1"
}

apply plugin: eclipsebuild.BuildDefinitionPlugin

ext.toolingApiBundleVersion = getBundleVersion(toolingApiVersion)

// define version mapping for the 3rd-party dependencies that are not specific to a particular Eclipse version
def eclipseVersionAgnosticDependencies = [
    'org.gradle.toolingapi'                 : toolingApiBundleVersion,
    'org.slf4j.api'                         : '1.7.30',
    'org.slf4j.simple'                      : '1.7.30',
    'com.google.guava'                      : '30.1.0',
    'com.google.gson'                       : '2.7.0',
    'org.apache.log4j'                      : '1.2.15',
    'org.eclipse.swtbot.eclipse.finder'     : '2.2.1',
    'org.eclipse.swtbot.junit4_x'           : '2.2.1',
    'org.jetbrains.kotlin.bundled-compiler' : '0.8.7',
    'org.jetbrains.kotlin.core'             : '0.8.7'
]

// target platform definition for all major Eclipse releases between version 4.3 and 4.8
// the default version is 48 which can be overridden through -Peclipse.version=<version>
// also the target platforms contain 1) the Eclipse SDK 2) the latest junit 3) SWTBot 2.2.1
eclipseBuild {
    defaultEclipseVersion = '423'

    final def swtPluginId = "org.eclipse.swt.${ECLIPSE_WS}.${ECLIPSE_OS}.${ECLIPSE_ARCH}"

    targetPlatform {
        eclipseVersion = '44'
        targetDefinition = file('tooling-e44.target')
        versionMapping = [
            "$swtPluginId"                          : '3.103.2',
            'com.ibm.icu'                           : '52.1.1',
            'org.eclipse.core.expressions'          : '3.4.600',
            'org.eclipse.core.filesystem'           : '1.4.100',
            'org.eclipse.core.net'                  : '1.2.200',
            'org.eclipse.core.resources'            : '3.9.1',
            'org.eclipse.core.runtime'              : '3.10.0',
            'org.eclipse.core.variables'            : '3.2.800',
            'org.eclipse.debug.core'                : '3.9.1',
            'org.eclipse.debug.ui'                  : '3.10.2',
            'org.eclipse.help'                      : '3.6.0',
            'org.eclipse.jdt.core'                  : '3.10.2',
            'org.eclipse.jdt.junit.core'            : '3.7.300',
            'org.eclipse.jdt.launching'             : '3.7.102',
            'org.eclipse.jdt.ui'                    : '3.10.2',
            'org.eclipse.jface.databinding'         : '1.6.200',
            'org.eclipse.jface.text'                : '3.9.2',
            'org.eclipse.ui'                        : '3.106.1',
            'org.eclipse.ui.console'                : '3.5.300',
            'org.eclipse.ui.editors'                : '3.8.200',
            'org.eclipse.ui.ide'                    : '3.10.2',
            'org.eclipse.ui.navigator'              : '3.5.401',
            'org.eclipse.ui.views'                  : '3.7.0',
            'org.eclipse.ui.workbench.texteditor'   : '3.9.0',
            'org.junit'                             : '4.11.0',
            'org.eclipse.emf.ecore'                 : '2.10.2',
            'org.eclipse.emf.edit'                  : '2.10.1',
        ] + eclipseVersionAgnosticDependencies
    }

    targetPlatform {
        eclipseVersion = '45'
        targetDefinition = file('tooling-e45.target')
        versionMapping = [
            "$swtPluginId"                          : '3.104.0',
            'com.ibm.icu'                           : '54.1.1',
            'org.eclipse.core.expressions'          : '3.5.0',
            'org.eclipse.core.filesystem'           : '1.5.0',
            'org.eclipse.core.net'                  : '1.2.300',
            'org.eclipse.core.resources'            : '3.10.0',
            'org.eclipse.core.runtime'              : '3.11.0',
            'org.eclipse.core.variables'            : '3.2.800',
            'org.eclipse.debug.core'                : '3.10.0',
            'org.eclipse.debug.ui'                  : '3.11.0',
            'org.eclipse.help'                      : '3.6.0',
            'org.eclipse.jdt.core'                  : '3.11.0',
            'org.eclipse.jdt.junit.core'            : '3.7.400',
            'org.eclipse.jdt.launching'             : '3.8.0',
            'org.eclipse.jdt.ui'                    : '3.11.0',
            'org.eclipse.jface.databinding'         : '1.7.0',
            'org.eclipse.jface.text'                : '3.10.0',
            'org.eclipse.ui'                        : '3.107.0',
            'org.eclipse.ui.console'                : '3.6.0',
            'org.eclipse.ui.editors'                : '3.9.0',
            'org.eclipse.ui.ide'                    : '3.11.0',
            'org.eclipse.ui.navigator'              : '3.6.0',
            'org.eclipse.ui.views'                  : '3.8.0',
            'org.eclipse.ui.workbench.texteditor'   : '3.9.100',
            'org.junit'                             : '4.12.0',
            'org.eclipse.emf.ecore'                 : '2.11.2',
            'org.eclipse.emf.edit'                  : '2.11.1',
            'org.eclipse.oomph.resources'           : '1.3.0',
            'org.eclipse.oomph.resources.edit'      : '1.3.0',
            'org.eclipse.oomph.predicates'          : '1.3.0',
            'org.eclipse.oomph.predicates.edit'     : '1.3.0',
            'org.eclipse.oomph.setup'               : '1.3.0',
            'org.eclipse.oomph.setup.edit'          : '1.3.0',
            'org.eclipse.oomph.base'                : '1.3.0',
            'org.eclipse.oomph.base.edit'           : '1.3.0'
        ] + eclipseVersionAgnosticDependencies
    }

    targetPlatform {
        eclipseVersion = '46'
        targetDefinition = file('tooling-e46.target')        
        versionMapping = [
            "$swtPluginId"                          : '3.105.0',
            'com.ibm.icu'                           : '56.1.0',
            'org.eclipse.core.expressions'          : '3.5.100',
            'org.eclipse.core.filesystem'           : '1.6.0',
            'org.eclipse.core.net'                  : '1.3.0',
            'org.eclipse.core.resources'            : '3.11.0',
            'org.eclipse.core.runtime'              : '3.12.0',
            'org.eclipse.core.variables'            : '3.3.0',
            'org.eclipse.debug.core'                : '3.10.100',
            'org.eclipse.debug.ui'                  : '3.11.200',
            'org.eclipse.help'                      : '3.7.0',
            'org.eclipse.jdt.core'                  : '3.12.0',
            'org.eclipse.jdt.junit.core'            : '3.8.0',
            'org.eclipse.jdt.launching'             : '3.8.100',
            'org.eclipse.jdt.ui'                    : '3.12.0',
            'org.eclipse.jface.databinding'         : '1.8.0',
            'org.eclipse.jface.text'                : '3.11.0',
            'org.eclipse.ui'                        : '3.108.0',
            'org.eclipse.ui.console'                : '3.6.200',
            'org.eclipse.ui.editors'                : '3.10.0',
            'org.eclipse.ui.ide'                    : '3.12.0',
            'org.eclipse.ui.navigator'              : '3.6.100',
            'org.eclipse.ui.views'                  : '3.8.100',
            'org.eclipse.ui.workbench.texteditor'   : '3.10.0',
            'org.junit'                             : '4.12.0',
            'org.eclipse.emf.ecore'                 : '2.12.0',
            'org.eclipse.emf.edit'                  : '2.12.0',
            'org.eclipse.oomph.resources'           : '1.7.0',
            'org.eclipse.oomph.resources.edit'      : '1.7.0',
            'org.eclipse.oomph.predicates'          : '1.7.0',
            'org.eclipse.oomph.predicates.edit'     : '1.7.0',
            'org.eclipse.oomph.setup'               : '1.7.0',
            'org.eclipse.oomph.setup.edit'          : '1.7.0',
            'org.eclipse.oomph.base'                : '1.7.0',
            'org.eclipse.oomph.base.edit'           : '1.7.0'
        ] + eclipseVersionAgnosticDependencies
    }

    targetPlatform {
        eclipseVersion = '47'
        targetDefinition = file('tooling-e47.target')
        versionMapping = [
            'org.eclipse.emf.ecore'                 : '2.13.0',
            'org.eclipse.emf.edit'                  : '2.12.0',
            'org.eclipse.oomph.resources'           : '1.8.0',
            'org.eclipse.oomph.resources.edit'      : '1.8.0',
            'org.eclipse.oomph.predicates'          : '1.8.0',
            'org.eclipse.oomph.predicates.edit'     : '1.8.0',
            'org.eclipse.oomph.setup'               : '1.8.0',
            'org.eclipse.oomph.setup.edit'          : '1.8.0',
            'org.eclipse.oomph.base'                : '1.8.0',
            'org.eclipse.oomph.base.edit'           : '1.8.0'
            ] + eclipseVersionAgnosticDependencies
    }

    targetPlatform {
        eclipseVersion = '48'
        targetDefinition = file('tooling-e48.target')
        versionMapping = [
            "$swtPluginId"                          : '3.107.0',
            'com.ibm.icu'                           : '58.2.0',
            'org.eclipse.core.expressions'          : '3.6.100',
            'org.eclipse.core.filesystem'           : '1.7.100',
            'org.eclipse.core.net'                  : '1.3.200',
            'org.eclipse.core.resources'            : '3.13.0',
            'org.eclipse.core.runtime'              : '3.14.0',
            'org.eclipse.core.variables'            : '3.4.100',
            'org.eclipse.debug.core'                : '3.12.0',
            'org.eclipse.debug.ui'                  : '3.13.0',
            'org.eclipse.help'                      : '3.8.100',
            'org.eclipse.jdt.core'                  : '3.14.0',
            'org.eclipse.jdt.junit.core'            : '3.10.0',
            'org.eclipse.jdt.launching'             : '3.10.0',
            'org.eclipse.jdt.ui'                    : '3.14.0',
            'org.eclipse.jface.databinding'         : '1.8.200',
            'org.eclipse.jface.text'                : '3.13.0',
            'org.eclipse.ui'                        : '3.109.100',
            'org.eclipse.ui.console'                : '3.8.0',
            'org.eclipse.ui.editors'                : '3.11.100',
            'org.eclipse.ui.ide'                    : '3.14.0',
            'org.eclipse.ui.navigator'              : '3.7.100',
            'org.eclipse.ui.views'                  : '3.9.100',
            'org.eclipse.ui.workbench.texteditor'   : '3.11.0',
            'org.junit'                             : '4.12.0',
            'org.eclipse.emf.ecore'                 : '2.14.0',
            'org.eclipse.emf.edit'                  : '2.13.0',
            'org.eclipse.oomph.resources'           : '1.9.0',
            'org.eclipse.oomph.resources.edit'      : '1.9.0',
            'org.eclipse.oomph.predicates'          : '1.9.0',
            'org.eclipse.oomph.predicates.edit'     : '1.9.0',
            'org.eclipse.oomph.setup'               : '1.9.0',
            'org.eclipse.oomph.setup.core'          : '1.9.0',
            'org.eclipse.oomph.setup.edit'          : '1.9.0',
            'org.eclipse.oomph.base'                : '1.9.0',
            'org.eclipse.oomph.base.edit'           : '1.9.0',
        ] + eclipseVersionAgnosticDependencies
    }

    targetPlatform {
        eclipseVersion = '49'
        targetDefinition = file('tooling-e49.target')
        versionMapping = [
            "$swtPluginId"                          : '3.108.0',
            'com.ibm.icu'                           : '62.1.0',
            'org.eclipse.core.expressions'          : '3.6.200',
            'org.eclipse.core.filesystem'           : '1.7.200',
            'org.eclipse.core.net'                  : '1.3.300',
            'org.eclipse.core.resources'            : '3.13.100',
            'org.eclipse.core.runtime'              : '3.15.0',
            'org.eclipse.core.variables'            : '3.4.200',
            'org.eclipse.debug.core'                : '3.13.0',
            'org.eclipse.debug.ui'                  : '3.13.100',
            'org.eclipse.help'                      : '3.8.200',
            'org.eclipse.jdt.core'                  : '3.15.0',
            'org.eclipse.jdt.junit.core'            : '3.10.100',
            'org.eclipse.jdt.launching'             : '3.11.0',
            'org.eclipse.jdt.ui'                    : '3.15.0',
            'org.eclipse.jface.databinding'         : '1.8.300',
            'org.eclipse.jface.text'                : '3.14.0',
            'org.eclipse.ui'                        : '3.110.0',
            'org.eclipse.ui.console'                : '3.8.100',
            'org.eclipse.ui.editors'                : '3.11.200',
            'org.eclipse.ui.ide'                    : '3.14.100',
            'org.eclipse.ui.navigator'              : '3.7.200',
            'org.eclipse.ui.views'                  : '3.9.200',
            'org.eclipse.ui.workbench.texteditor'   : '3.11.100',
            'org.junit'                             : '4.12.0',
            'org.eclipse.emf.ecore'                 : '2.15.0',
            'org.eclipse.emf.edit'                  : '2.14.0',
            'org.eclipse.oomph.resources'           : '1.10.0',
            'org.eclipse.oomph.resources.edit'      : '1.10.0',
            'org.eclipse.oomph.predicates'          : '1.10.0',
            'org.eclipse.oomph.predicates.edit'     : '1.10.0',
            'org.eclipse.oomph.setup'               : '1.10.0',
            'org.eclipse.oomph.setup.core'          : '1.10.0',
            'org.eclipse.oomph.setup.edit'          : '1.10.0',
            'org.eclipse.oomph.base'                : '1.10.0',
            'org.eclipse.oomph.base.edit'           : '1.10.0'
        ] + eclipseVersionAgnosticDependencies
    }

    targetPlatform {
        eclipseVersion = '410'
        targetDefinition = file('tooling-e410.target')
        versionMapping = [
            "$swtPluginId"                          : '3.109.0',
            'com.ibm.icu'                           : '63.1.0',
            'org.eclipse.core.expressions'          : '3.6.200',
            'org.eclipse.core.filesystem'           : '1.7.200',
            'org.eclipse.core.net'                  : '1.3.400',
            'org.eclipse.core.resources'            : '3.13.200',
            'org.eclipse.core.runtime'              : '3.15.100',
            'org.eclipse.core.variables'            : '3.4.300',
            'org.eclipse.debug.core'                : '3.13.100',
            'org.eclipse.debug.ui'                  : '3.13.200',
            'org.eclipse.help'                      : '3.8.200',
            'org.eclipse.jdt.core'                  : '3.16.0',
            'org.eclipse.jdt.junit.core'            : '3.10.200',
            'org.eclipse.jdt.launching'             : '3.12.0',
            'org.eclipse.jdt.ui'                    : '3.16.0',
            'org.eclipse.jface.databinding'         : '1.8.400',
            'org.eclipse.jface.text'                : '3.15.0',
            'org.eclipse.ui'                        : '3.111.0',
            'org.eclipse.ui.console'                : '3.8.300',
            'org.eclipse.ui.editors'                : '3.11.300',
            'org.eclipse.ui.ide'                    : '3.14.200',
            'org.eclipse.ui.navigator'              : '3.7.300',
            'org.eclipse.ui.views'                  : '3.9.200',
            'org.eclipse.ui.workbench.texteditor'   : '3.11.200',
            'org.junit'                             : '4.12.0',
            'org.eclipse.emf.ecore'                 : '2.16.0',
            'org.eclipse.emf.edit'                  : '2.14.0',
            'org.eclipse.oomph.resources'           : '1.10.0',
            'org.eclipse.oomph.resources.edit'      : '1.10.0',
            'org.eclipse.oomph.predicates'          : '1.10.0',
            'org.eclipse.oomph.predicates.edit'     : '1.10.0',
            'org.eclipse.oomph.setup'               : '1.10.0',
            'org.eclipse.oomph.setup.core'          : '1.11.0',
            'org.eclipse.oomph.setup.edit'          : '1.10.0',
            'org.eclipse.oomph.base'                : '1.10.0',
            'org.eclipse.oomph.base.edit'           : '1.10.0'
        ] + eclipseVersionAgnosticDependencies
    }

    targetPlatform {
        eclipseVersion = '411'
        targetDefinition = file('tooling-e411.target')
        versionMapping = [
            "$swtPluginId"                          : '3.110.0',
            'com.ibm.icu'                           : '63.1.0',
            'org.eclipse.core.expressions'          : '3.6.300',
            'org.eclipse.core.filesystem'           : '1.7.300',
            'org.eclipse.core.net'                  : '1.3.400',
            'org.eclipse.core.resources'            : '3.13.300',
            'org.eclipse.core.runtime'              : '3.15.200',
            'org.eclipse.core.variables'            : '3.4.400',
            'org.eclipse.debug.core'                : '3.13.200',
            'org.eclipse.debug.ui'                  : '3.14.0',
            'org.eclipse.help'                      : '3.8.300',
            'org.eclipse.jdt.core'                  : '3.17.0',
            'org.eclipse.jdt.junit.core'            : '3.10.200',
            'org.eclipse.jdt.launching'             : '3.13.0',
            'org.eclipse.jdt.ui'                    : '3.17.0',
            'org.eclipse.jface.databinding'         : '1.8.500',
            'org.eclipse.jface.text'                : '3.15.100',
            'org.eclipse.ui'                        : '3.112.0',
            'org.eclipse.ui.console'                : '3.8.400',
            'org.eclipse.ui.editors'                : '3.11.400',
            'org.eclipse.ui.ide'                    : '3.15.0',
            'org.eclipse.ui.navigator'              : '3.7.400',
            'org.eclipse.ui.views'                  : '3.9.300',
            'org.eclipse.ui.workbench.texteditor'   : '3.11.300',
            'org.junit'                             : '4.12.0',
            'org.eclipse.emf.ecore'                 : '2.17.0',
            'org.eclipse.emf.edit'                  : '2.14.0',
            'org.eclipse.oomph.resources'           : '1.10.0',
            'org.eclipse.oomph.resources.edit'      : '1.10.0',
            'org.eclipse.oomph.predicates'          : '1.10.0',
            'org.eclipse.oomph.predicates.edit'     : '1.10.0',
            'org.eclipse.oomph.setup'               : '1.12.0',
            'org.eclipse.oomph.setup.core'          : '1.12.0',
            'org.eclipse.oomph.setup.edit'          : '1.12.0',
            'org.eclipse.oomph.base'                : '1.10.0',
            'org.eclipse.oomph.base.edit'           : '1.10.0'
        ] + eclipseVersionAgnosticDependencies
    }
    
    targetPlatform {
        eclipseVersion = '412'
        targetDefinition = file('tooling-e412.target')
        versionMapping = [
            "$swtPluginId"                          : '3.111.0',
            'com.ibm.icu'                           : '64.2.0',
            'org.eclipse.core.expressions'          : '3.6.400',
            'org.eclipse.core.filesystem'           : '1.7.400',
            'org.eclipse.core.net'                  : '1.3.500',
            'org.eclipse.core.resources'            : '3.13.400',
            'org.eclipse.core.runtime'              : '3.15.300',
            'org.eclipse.core.variables'            : '3.4.500',
            'org.eclipse.debug.core'                : '3.13.300',
            'org.eclipse.debug.ui'                  : '3.14.100',
            'org.eclipse.help'                      : '3.8.400',
            'org.eclipse.jdt.core'                  : '3.18.0',
            'org.eclipse.jdt.junit.core'            : '3.10.300',
            'org.eclipse.jdt.launching'             : '3.14.0',
            'org.eclipse.jdt.ui'                    : '3.18.0',
            'org.eclipse.jface.databinding'         : '1.9.0',
            'org.eclipse.jface.text'                : '3.15.200',
            'org.eclipse.ui'                        : '3.113.0',
            'org.eclipse.ui.console'                : '3.8.500',
            'org.eclipse.ui.editors'                : '3.11.500',
            'org.eclipse.ui.ide'                    : '3.15.200',
            'org.eclipse.ui.navigator'              : '3.8.0',
            'org.eclipse.ui.views'                  : '3.9.400',
            'org.eclipse.ui.workbench.texteditor'   : '3.12.0',
            'org.junit'                             : '4.12.0',
            'org.eclipse.emf.ecore'                 : '2.18.0',
            'org.eclipse.emf.edit'                  : '2.15.0',
            'org.eclipse.oomph.resources'           : '1.11.0',
            'org.eclipse.oomph.resources.edit'      : '1.10.0',
            'org.eclipse.oomph.predicates'          : '1.10.0',
            'org.eclipse.oomph.predicates.edit'     : '1.10.0',
            'org.eclipse.oomph.setup'               : '1.13.0',
            'org.eclipse.oomph.setup.core'          : '1.13.0',
            'org.eclipse.oomph.setup.edit'          : '1.13.0',
            'org.eclipse.oomph.base'                : '1.11.0',
            'org.eclipse.oomph.base.edit'           : '1.11.0'
        ] + eclipseVersionAgnosticDependencies
    }
    
    targetPlatform {
        eclipseVersion = '413'
        targetDefinition = file('tooling-e413.target')
        versionMapping = [
            "$swtPluginId"                          : '3.112.0',
            'com.ibm.icu'                           : '64.2.0',
            'org.eclipse.core.expressions'          : '3.6.500',
            'org.eclipse.core.filesystem'           : '1.7.500',
            'org.eclipse.core.net'                  : '1.3.600',
            'org.eclipse.core.resources'            : '3.13.500',
            'org.eclipse.core.runtime'              : '3.16.0',
            'org.eclipse.core.variables'            : '3.4.600',
            'org.eclipse.debug.core'                : '3.14.0',
            'org.eclipse.debug.ui'                  : '3.14.200',
            'org.eclipse.help'                      : '3.8.500',
            'org.eclipse.jdt.core'                  : '3.19.0',
            'org.eclipse.jdt.junit.core'            : '3.10.400',
            'org.eclipse.jdt.launching'             : '3.15.0',
            'org.eclipse.jdt.ui'                    : '3.19.0',
            'org.eclipse.jface.databinding'         : '1.9.100',
            'org.eclipse.jface.text'                : '3.15.300',
            'org.eclipse.ui'                        : '3.114.0',
            'org.eclipse.ui.console'                : '3.8.600',
            'org.eclipse.ui.editors'                : '3.12.0',
            'org.eclipse.ui.ide'                    : '3.16.0',
            'org.eclipse.ui.navigator'              : '3.9.0',
            'org.eclipse.ui.views'                  : '3.10.0',
            'org.eclipse.ui.workbench.texteditor'   : '3.13.0',
            'org.junit'                             : '4.12.0',
            'org.eclipse.emf.ecore'                 : '2.19.0',
            'org.eclipse.emf.edit'                  : '2.15.0',
            'org.eclipse.oomph.resources'           : '1.11.0',
            'org.eclipse.oomph.resources.edit'      : '1.10.0',
            'org.eclipse.oomph.predicates'          : '1.10.0',
            'org.eclipse.oomph.predicates.edit'     : '1.10.0',
            'org.eclipse.oomph.setup'               : '1.14.0',
            'org.eclipse.oomph.setup.core'          : '1.14.0',
            'org.eclipse.oomph.setup.edit'          : '1.14.0',
            'org.eclipse.oomph.base'                : '1.12.0',
            'org.eclipse.oomph.base.edit'           : '1.12.0'
        ] + eclipseVersionAgnosticDependencies
    }
    
    targetPlatform {
        eclipseVersion = '414'
        targetDefinition = file('tooling-e414.target')
        versionMapping = [
            "$swtPluginId"                          : '3.113.0',
            'com.ibm.icu'                           : '64.2.0',
            'org.eclipse.core.expressions'          : '3.6.600',
            'org.eclipse.core.filesystem'           : '1.7.600',
            'org.eclipse.core.net'                  : '1.3.700',
            'org.eclipse.core.resources'            : '3.13.600',
            'org.eclipse.core.runtime'              : '3.17.0',
            'org.eclipse.core.variables'            : '3.4.700',
            'org.eclipse.debug.core'                : '3.14.100',
            'org.eclipse.debug.ui'                  : '3.14.300',
            'org.eclipse.help'                      : '3.8.600',
            'org.eclipse.jdt.core'                  : '3.20.0',
            'org.eclipse.jdt.junit.core'            : '3.10.500',
            'org.eclipse.jdt.launching'             : '3.16.0',
            'org.eclipse.jdt.ui'                    : '3.20.0',
            'org.eclipse.jface.databinding'         : '1.9.200',
            'org.eclipse.jface.text'                : '3.16.100',
            'org.eclipse.ui'                        : '3.115.0',
            'org.eclipse.ui.console'                : '3.9.0',
            'org.eclipse.ui.editors'                : '3.13.0',
            'org.eclipse.ui.ide'                    : '3.16.100',
            'org.eclipse.ui.navigator'              : '3.9.100',
            'org.eclipse.ui.views'                  : '3.10.100',
            'org.eclipse.ui.workbench.texteditor'   : '3.14.0',
            'org.junit'                             : '4.12.0',
            'org.eclipse.emf.ecore'                 : '2.20.0',
            'org.eclipse.emf.edit'                  : '2.16.0',
            'org.eclipse.oomph.resources'           : '1.12.0',
            'org.eclipse.oomph.resources.edit'      : '1.10.0',
            'org.eclipse.oomph.predicates'          : '1.11.0',
            'org.eclipse.oomph.predicates.edit'     : '1.10.0',
            'org.eclipse.oomph.setup'               : '1.15.0',
            'org.eclipse.oomph.setup.core'          : '1.15.0',
            'org.eclipse.oomph.setup.edit'          : '1.14.0',
            'org.eclipse.oomph.base'                : '1.12.0',
            'org.eclipse.oomph.base.edit'           : '1.12.0'
        ] + eclipseVersionAgnosticDependencies
    }
    
    targetPlatform {
        eclipseVersion = '415'
        targetDefinition = file('tooling-e415.target')
        versionMapping = [
            "$swtPluginId"                          : '3.114.0',
            'com.ibm.icu'                           : '64.2.0',
            'org.eclipse.core.expressions'          : '3.6.700',
            'org.eclipse.core.filesystem'           : '1.7.700',
            'org.eclipse.core.net'                  : '1.3.800',
            'org.eclipse.core.resources'            : '3.13.700',
            'org.eclipse.core.runtime'              : '3.17.100',
            'org.eclipse.core.variables'            : '3.4.800',
            'org.eclipse.debug.core'                : '3.15.0',
            'org.eclipse.debug.ui'                  : '3.14.400',
            'org.eclipse.help'                      : '3.8.700',
            'org.eclipse.jdt.core'                  : '3.21.0',
            'org.eclipse.jdt.junit.core'            : '3.10.600',
            'org.eclipse.jdt.launching'             : '3.17.0',
            'org.eclipse.jdt.ui'                    : '3.21.0',
            'org.eclipse.jface.databinding'         : '1.11.0',
            'org.eclipse.jface.text'                : '3.16.200',
            'org.eclipse.ui'                        : '3.116.0',
            'org.eclipse.ui.console'                : '3.9.100',
            'org.eclipse.ui.editors'                : '3.13.100',
            'org.eclipse.ui.ide'                    : '3.17.0',
            'org.eclipse.ui.navigator'              : '3.9.200',
            'org.eclipse.ui.views'                  : '3.10.200',
            'org.eclipse.ui.workbench.texteditor'   : '3.14.100',
            'org.junit'                             : '4.13.0',
            'org.eclipse.emf.ecore'                 : '2.21.0',
            'org.eclipse.emf.edit'                  : '2.16.0',
            'org.eclipse.oomph.resources'           : '1.12.0',
            'org.eclipse.oomph.resources.edit'      : '1.10.0',
            'org.eclipse.oomph.predicates'          : '1.11.0',
            'org.eclipse.oomph.predicates.edit'     : '1.10.0',
            'org.eclipse.oomph.setup'               : '1.16.0',
            'org.eclipse.oomph.setup.core'          : '1.16.0',
            'org.eclipse.oomph.setup.edit'          : '1.14.0',
            'org.eclipse.oomph.base'                : '1.13.0',
            'org.eclipse.oomph.base.edit'           : '1.12.0'
        ]
    }
    
    targetPlatform {
        eclipseVersion = '416'
        targetDefinition = file('tooling-e416.target')
        versionMapping = [
            "$swtPluginId"                          : '3.114.100',
            'com.ibm.icu'                           : '64.2.0',
            'org.eclipse.core.expressions'          : '3.6.800',
            'org.eclipse.core.filesystem'           : '1.7.700',
            'org.eclipse.core.net'                  : '1.3.900',
            'org.eclipse.core.resources'            : '3.13.700',
            'org.eclipse.core.runtime'              : '3.18.0',
            'org.eclipse.core.variables'            : '3.4.800',
            'org.eclipse.debug.core'                : '3.15.100',
            'org.eclipse.debug.ui'                  : '3.14.500',
            'org.eclipse.help'                      : '3.8.800',
            'org.eclipse.jdt.core'                  : '3.22.0',
            'org.eclipse.jdt.junit.core'            : '3.10.700',
            'org.eclipse.jdt.launching'             : '3.17.100',
            'org.eclipse.jdt.ui'                    : '3.21.100',
            'org.eclipse.jface.databinding'         : '1.11.100',
            'org.eclipse.jface.text'                : '3.16.300',
            'org.eclipse.ui'                        : '3.117.0',
            'org.eclipse.ui.console'                : '3.9.200',
            'org.eclipse.ui.editors'                : '3.13.200',
            'org.eclipse.ui.ide'                    : '3.17.100',
            'org.eclipse.ui.navigator'              : '3.9.300',
            'org.eclipse.ui.views'                  : '3.10.300',
            'org.eclipse.ui.workbench.texteditor'   : '3.14.200',
            'org.junit'                             : '4.13.0',
            'org.eclipse.emf.ecore'                 : '2.22.0',
            'org.eclipse.emf.edit'                  : '2.16.0',
            'org.eclipse.oomph.resources'           : '1.13.0',
            'org.eclipse.oomph.resources.edit'      : '1.10.0',
            'org.eclipse.oomph.predicates'          : '1.11.0',
            'org.eclipse.oomph.predicates.edit'     : '1.10.0',
            'org.eclipse.oomph.setup'               : '1.17.0',
            'org.eclipse.oomph.setup.core'          : '1.17.0',
            'org.eclipse.oomph.setup.edit'          : '1.14.0',
            'org.eclipse.oomph.base'                : '1.13.0',
            'org.eclipse.oomph.base.edit'           : '1.12.0'
         ]
    }
    
    targetPlatform {
        eclipseVersion = '417'
        targetDefinition = file('tooling-e417.target')
        versionMapping = [
            "$swtPluginId"                          : '3.115.0',
            'com.ibm.icu'                           : '67.1.0',
            'org.eclipse.core.expressions'          : '3.7.0',
            'org.eclipse.core.filesystem'           : '1.7.700',
            'org.eclipse.core.net'                  : '1.3.1000',
            'org.eclipse.core.resources'            : '3.13.800',
            'org.eclipse.core.runtime'              : '3.19.0',
            'org.eclipse.core.variables'            : '3.4.800',
            'org.eclipse.debug.core'                : '3.16.0',
            'org.eclipse.debug.ui'                  : '3.14.600',
            'org.eclipse.help'                      : '3.8.800',
            'org.eclipse.jdt.core'                  : '3.23.0',
            'org.eclipse.jdt.junit.core'            : '3.10.800',
            'org.eclipse.jdt.launching'             : '3.18.0',
            'org.eclipse.jdt.ui'                    : '3.21.200',
            'org.eclipse.jface.databinding'         : '1.12.0',
            'org.eclipse.jface.text'                : '3.16.400',
            'org.eclipse.ui'                        : '3.118.0',
            'org.eclipse.ui.console'                : '3.9.300',
            'org.eclipse.ui.editors'                : '3.13.300',
            'org.eclipse.ui.ide'                    : '3.17.200',
            'org.eclipse.ui.navigator'              : '3.9.400',
            'org.eclipse.ui.views'                  : '3.10.400',
            'org.eclipse.ui.workbench.texteditor'   : '3.15.0',
            'org.junit'                             : '4.13.0',
            'org.eclipse.emf.ecore'                 : '2.23.0',
            'org.eclipse.emf.edit'                  : '2.16.0',
            'org.eclipse.oomph.resources'           : '1.14.0',
            'org.eclipse.oomph.resources.edit'      : '1.11.0',
            'org.eclipse.oomph.predicates'          : '1.12.0',
            'org.eclipse.oomph.predicates.edit'     : '1.11.0',
            'org.eclipse.oomph.setup'               : '1.18.0',
            'org.eclipse.oomph.setup.core'          : '1.18.0',
            'org.eclipse.oomph.setup.edit'          : '1.15.0',
            'org.eclipse.oomph.base'                : '1.14.0',
            'org.eclipse.oomph.base.edit'           : '1.13.0'
        ]
    }

    targetPlatform {
        eclipseVersion = '418'
        targetDefinition = file('tooling-e418.target')
        versionMapping = [
            "$swtPluginId"                          : '3.115.100',
            'com.ibm.icu'                           : '67.1.0',
            'org.eclipse.core.expressions'          : '3.7.0',
            'org.eclipse.core.filesystem'           : '1.7.700',
            'org.eclipse.core.net'                  : '1.3.1000',
            'org.eclipse.core.resources'            : '3.13.900',
            'org.eclipse.core.runtime'              : '3.20.0',
            'org.eclipse.core.variables'            : '3.4.800',
            'org.eclipse.debug.core'                : '3.17.0',
            'org.eclipse.debug.ui'                  : '3.14.700',
            'org.eclipse.help'                      : '3.8.800',
            'org.eclipse.jdt.core'                  : '3.24.0',
            'org.eclipse.jdt.junit.core'            : '3.10.900',
            'org.eclipse.jdt.launching'             : '3.19.0',
            'org.eclipse.jdt.ui'                    : '3.22.0',
            'org.eclipse.jface.databinding'         : '1.12.100',
            'org.eclipse.jface.text'                : '3.16.500',
            'org.eclipse.ui'                        : '3.118.100',
            'org.eclipse.ui.console'                : '3.10.0',
            'org.eclipse.ui.editors'                : '3.13.400',
            'org.eclipse.ui.ide'                    : '3.18.0',
            'org.eclipse.ui.navigator'              : '3.9.500',
            'org.eclipse.ui.views'                  : '3.10.500',
            'org.eclipse.ui.workbench.texteditor'   : '3.15.100',
            'org.junit'                             : '4.13.0',
            'org.eclipse.emf.ecore'                 : '2.23.0',
            'org.eclipse.emf.edit'                  : '2.16.0',
            'org.eclipse.oomph.resources'           : '1.14.0',
            'org.eclipse.oomph.resources.edit'      : '1.11.0',
            'org.eclipse.oomph.predicates'          : '1.12.0',
            'org.eclipse.oomph.predicates.edit'     : '1.11.0',
            'org.eclipse.oomph.setup'               : '1.18.0',
            'org.eclipse.oomph.setup.core'          : '1.18.0',
            'org.eclipse.oomph.setup.edit'          : '1.15.0',
            'org.eclipse.oomph.base'                : '1.14.0',
            'org.eclipse.oomph.base.edit'           : '1.13.0'
        ]
    }

    targetPlatform {
        eclipseVersion = '419'
        targetDefinition = file('tooling-e419.target')
        versionMapping = [
            "$swtPluginId"                          : '3.116.0',
            'com.ibm.icu'                           : '67.1.0',
            'org.eclipse.core.expressions'          : '3.7.100',
            'org.eclipse.core.filesystem'           : '1.7.700',
            'org.eclipse.core.net'                  : '1.3.1000',
            'org.eclipse.core.resources'            : '3.14.0',
            'org.eclipse.core.runtime'              : '3.20.100',
            'org.eclipse.core.variables'            : '3.4.800',
            'org.eclipse.debug.core'                : '3.18.0',
            'org.eclipse.debug.ui'                  : '3.14.800',
            'org.eclipse.help'                      : '3.8.800',
            'org.eclipse.jdt.core'                  : '3.25.0',
            'org.eclipse.jdt.junit.core'            : '3.10.1000',
            'org.eclipse.jdt.launching'             : '3.19.100',
            'org.eclipse.jdt.ui'                    : '3.22.100',
            'org.eclipse.jface.databinding'         : '1.12.200',
            'org.eclipse.jface.text'                : '3.17.0',
            'org.eclipse.ui'                        : '3.119.0',
            'org.eclipse.ui.console'                : '3.10.100',
            'org.eclipse.ui.editors'                : '3.14.0',
            'org.eclipse.ui.ide'                    : '3.18.100',
            'org.eclipse.ui.navigator'              : '3.10.0',
            'org.eclipse.ui.views'                  : '3.11.0',
            'org.eclipse.ui.workbench.texteditor'   : '3.16.0',
            'org.junit'                             : '4.13.0',
            'org.eclipse.emf.ecore'                 : '2.23.0',
            'org.eclipse.emf.edit'                  : '2.16.0',
            'org.eclipse.oomph.resources'           : '1.15.0',
            'org.eclipse.oomph.resources.edit'      : '1.11.0',
            'org.eclipse.oomph.predicates'          : '1.12.0',
            'org.eclipse.oomph.predicates.edit'     : '1.11.0',
            'org.eclipse.oomph.setup'               : '1.19.0',
            'org.eclipse.oomph.setup.core'          : '1.19.0',
            'org.eclipse.oomph.setup.edit'          : '1.15.0',
            'org.eclipse.oomph.base'                : '1.14.0',
            'org.eclipse.oomph.base.edit'           : '1.13.0'
        ]
    }

    targetPlatform {
        eclipseVersion = '420'
        targetDefinition = file('tooling-e420.target')
        versionMapping = [
            "$swtPluginId"                          : '3.116.100',
            'com.ibm.icu'                           : '67.1.0',
            'org.eclipse.core.expressions'          : '3.7.100',
            'org.eclipse.core.filesystem'           : '1.9.0',
            'org.eclipse.core.net'                  : '1.3.1100',
            'org.eclipse.core.resources'            : '3.15.0',
            'org.eclipse.core.runtime'              : '3.22.0',
            'org.eclipse.core.variables'            : '3.5.0',
            'org.eclipse.debug.core'                : '3.18.100',
            'org.eclipse.debug.ui'                  : '3.15.0',
            'org.eclipse.help'                      : '3.9.0',
            'org.eclipse.jdt.core'                  : '3.26.0',
            'org.eclipse.jdt.junit.core'            : '3.10.1100',
            'org.eclipse.jdt.launching'             : '3.19.200',
            'org.eclipse.jdt.ui'                    : '3.23.0',
            'org.eclipse.jface.databinding'         : '1.12.200',
            'org.eclipse.jface.text'                : '3.18.0',
            'org.eclipse.ui'                        : '3.119.0',
            'org.eclipse.ui.console'                : '3.11.0',
            'org.eclipse.ui.editors'                : '3.14.100',
            'org.eclipse.ui.ide'                    : '3.18.200',
            'org.eclipse.ui.navigator'              : '3.10.100',
            'org.eclipse.ui.views'                  : '3.11.0',
            'org.eclipse.ui.workbench.texteditor'   : '3.16.100',
            'org.junit'                             : '4.13.0',
            'org.eclipse.emf.ecore'                 : '2.24.0',
            'org.eclipse.emf.edit'                  : '2.16.0',
            'org.eclipse.oomph.resources'           : '1.15.0',
            'org.eclipse.oomph.resources.edit'      : '1.11.0',
            'org.eclipse.oomph.predicates'          : '1.12.0',
            'org.eclipse.oomph.predicates.edit'     : '1.11.0',
            'org.eclipse.oomph.setup'               : '1.20.0',
            'org.eclipse.oomph.setup.core'          : '1.20.0',
            'org.eclipse.oomph.setup.edit'          : '1.15.0',
            'org.eclipse.oomph.base'                : '1.14.0',
            'org.eclipse.oomph.base.edit'           : '1.13.0'
        ]
    }

    targetPlatform {
        eclipseVersion = '421'
        targetDefinition = file('tooling-e421.target')
        versionMapping = [
            "$swtPluginId"                          : '3.117.0',
            'com.ibm.icu'                           : '67.1.0',
            'org.eclipse.core.expressions'          : '3.8.0',
            'org.eclipse.core.filesystem'           : '1.9.100',
            'org.eclipse.core.net'                  : '1.3.1100',
            'org.eclipse.core.resources'            : '3.15.100',
            'org.eclipse.core.runtime'              : '3.23.0',
            'org.eclipse.core.variables'            : '3.5.100',
            'org.eclipse.debug.core'                : '3.18.200',
            'org.eclipse.debug.ui'                  : '3.15.100',
            'org.eclipse.help'                      : '3.9.100',
            'org.eclipse.jdt.core'                  : '3.27.0',
            'org.eclipse.jdt.junit.core'            : '3.11.0',
            'org.eclipse.jdt.launching'             : '3.19.300',
            'org.eclipse.jdt.ui'                    : '3.24.0',
            'org.eclipse.jface.databinding'         : '1.13.0',
            'org.eclipse.jface.text'                : '3.18.100',
            'org.eclipse.ui'                        : '3.119.100',
            'org.eclipse.ui.console'                : '3.11.100',
            'org.eclipse.ui.editors'                : '3.14.200',
            'org.eclipse.ui.ide'                    : '3.18.300',
            'org.eclipse.ui.navigator'              : '3.10.100',
            'org.eclipse.ui.views'                  : '3.11.100',
            'org.eclipse.ui.workbench.texteditor'   : '3.16.200',
            'org.junit'                             : '4.13.0',
            'org.eclipse.emf.ecore'                 : '2.25.0',
            'org.eclipse.emf.edit'                  : '2.16.0',
            'org.eclipse.oomph.resources'           : '1.15.0',
            'org.eclipse.oomph.resources.edit'      : '1.11.0',
            'org.eclipse.oomph.predicates'          : '1.12.0',
            'org.eclipse.oomph.predicates.edit'     : '1.11.0',
            'org.eclipse.oomph.setup'               : '1.21.0',
            'org.eclipse.oomph.setup.core'          : '1.21.0',
            'org.eclipse.oomph.setup.edit'          : '1.15.0',
            'org.eclipse.oomph.base'                : '1.14.0',
            'org.eclipse.oomph.base.edit'           : '1.13.0'
        ]
    }

    targetPlatform {
        eclipseVersion = '422'
        targetDefinition = file('tooling-e422.target')
        versionMapping = [
            "$swtPluginId"                          : '3.118.0',
            'com.ibm.icu'                           : '67.1.0',
            'org.eclipse.core.expressions'          : '3.8.100',
            'org.eclipse.core.filesystem'           : '1.9.200',
            'org.eclipse.core.net'                  : '1.3.1100',
            'org.eclipse.core.resources'            : '3.16.0',
            'org.eclipse.core.runtime'              : '3.24.0',
            'org.eclipse.core.variables'            : '3.5.100',
            'org.eclipse.debug.core'                : '3.18.300',
            'org.eclipse.debug.ui'                  : '3.15.200',
            'org.eclipse.help'                      : '3.9.100',
            'org.eclipse.jdt.core'                  : '3.28.0',
            'org.eclipse.jdt.junit.core'            : '3.11.100',
            'org.eclipse.jdt.launching'             : '3.19.400',
            'org.eclipse.jdt.ui'                    : '3.25.0',
            'org.eclipse.jface.databinding'         : '1.13.0',
            'org.eclipse.jface.text'                : '3.19.0',
            'org.eclipse.ui'                        : '3.200.0',
            'org.eclipse.ui.console'                : '3.11.100',
            'org.eclipse.ui.editors'                : '3.14.300',
            'org.eclipse.ui.ide'                    : '3.18.400',
            'org.eclipse.ui.navigator'              : '3.10.200',
            'org.eclipse.ui.views'                  : '3.11.100',
            'org.eclipse.ui.workbench.texteditor'   : '3.16.300',
            'org.junit'                             : '4.13.2',
            'org.eclipse.emf.ecore'                 : '2.25.0',
            'org.eclipse.emf.edit'                  : '2.16.0',
            'org.eclipse.oomph.resources'           : '1.15.0',
            'org.eclipse.oomph.resources.edit'      : '1.11.0',
            'org.eclipse.oomph.predicates'          : '1.13.0',
            'org.eclipse.oomph.predicates.edit'     : '1.11.0',
            'org.eclipse.oomph.setup'               : '1.22.0',
            'org.eclipse.oomph.setup.core'          : '1.22.0',
            'org.eclipse.oomph.setup.edit'          : '1.15.0',
            'org.eclipse.oomph.base'                : '1.15.0',
            'org.eclipse.oomph.base.edit'           : '1.13.0'
        ]
    }

    targetPlatform {
        eclipseVersion = '423'
        targetDefinition = file('tooling-e423.target')
        versionMapping = [
            "$swtPluginId"                          : '3.119.0',
            'com.ibm.icu'                           : '67.1.0',
            'org.eclipse.core.expressions'          : '3.8.100',
            'org.eclipse.core.filesystem'           : '1.9.300',
            'org.eclipse.core.net'                  : '1.3.1100',
            'org.eclipse.core.resources'            : '3.16.100',
            'org.eclipse.core.runtime'              : '3.24.100',
            'org.eclipse.core.variables'            : '3.5.100',
            'org.eclipse.debug.core'                : '3.19.0',
            'org.eclipse.debug.ui'                  : '3.16.0',
            'org.eclipse.help'                      : '3.9.100',
            'org.eclipse.jdt.core'                  : '3.29.0',
            'org.eclipse.jdt.junit.core'            : '3.11.200',
            'org.eclipse.jdt.launching'             : '3.19.500',
            'org.eclipse.jdt.ui'                    : '3.26.0',
            'org.eclipse.jface.databinding'         : '1.13.0',
            'org.eclipse.jface.text'                : '3.20.0',
            'org.eclipse.ui'                        : '3.201.0',
            'org.eclipse.ui.console'                : '3.11.100',
            'org.eclipse.ui.editors'                : '3.14.300',
            'org.eclipse.ui.ide'                    : '3.18.500',
            'org.eclipse.ui.navigator'              : '3.10.200',
            'org.eclipse.ui.views'                  : '3.11.100',
            'org.eclipse.ui.workbench.texteditor'   : '3.16.400',
            'org.junit'                             : '4.13.2',
            'org.eclipse.emf.ecore'                 : '2.26.0',
            'org.eclipse.emf.edit'                  : '2.17.0',
            'org.eclipse.oomph.resources'           : '1.16.0',
            'org.eclipse.oomph.resources.edit'      : '1.12.0',
            'org.eclipse.oomph.predicates'          : '1.14.0',
            'org.eclipse.oomph.predicates.edit'     : '1.12.0',
            'org.eclipse.oomph.setup'               : '1.23.0',
            'org.eclipse.oomph.setup.core'          : '1.23.0',
            'org.eclipse.oomph.setup.edit'          : '1.16.0',
            'org.eclipse.oomph.base'                : '1.16.0',
            'org.eclipse.oomph.base.edit'           : '1.14.0',
        ]
    }

    scmRepo = "https://github.com/eclipse/buildship.git"
    commitId = currentCommitId()
}

// read the current version from an external file and add a timestamp suffix if requested by the caller
ext.baseVersion = file('version.txt').text.trim()
ext.versionQualifier = getVersionQualifier()
version = baseVersion + '.' + versionQualifier

// ensure that the assembleTargetPlatform is executed when the gradle.properties file is changed
project.assembleTargetPlatform.inputs.file file('gradle.properties')

// delete the org.eclipse.core.runtime.compatibility.registry plugin from the target platform
// it causes classpath issues when the the Spock tests are running with Groovy 2.4; only
// contains files to provide 2.x compatibility hence it's safe to remove
project.assembleTargetPlatform.doLast {
    def config = Config.on(project)
    if (config.targetPlatform.eclipseVersion in ['43', '44', '45']) {
        def registryPluginId = 'org.eclipse.core.runtime.compatibility.registry'

        project.exec {
            // redirect the external process output to the logging
            standardOutput = new LogOutputStream(project.logger, LogLevel.INFO)
            errorOutput = new LogOutputStream(project.logger, LogLevel.INFO)

            commandLine(config.eclipseSdkExe.path,
                    '-application', 'org.eclipse.equinox.p2.director',
                    '-uninstallIU', registryPluginId,
                    '-tag', 'target-platform-2',
                    '-destination', config.nonMavenizedTargetPlatformDir.path,
                    '-profile', 'SDKProfile',
                    '-bundlepool', config.nonMavenizedTargetPlatformDir.path,
                    '-p2.os', Constants.os,
                    '-p2.ws', Constants.ws,
                    '-p2.arch', Constants.arch,
                    '-roaming',
                    '-nosplash')
        }

        def bundlesInfo = new File(config.nonMavenizedTargetPlatformDir, 'configuration/org.eclipse.equinox.simpleconfigurator/bundles.info')
        def updatedInfo = ''
        bundlesInfo.withReader { reader ->
            def line
            while (line = reader.readLine()) {
                if (!line.contains(registryPluginId)) {
                    updatedInfo += line + '\n'
                }
            }
        }
        bundlesInfo.text = updatedInfo
    }
}

subprojects {
    // set the calculated version on all projects in the hierarchy
    version = rootProject.version

    plugins.withType(JavaPlugin) {
        def config = Config.on(project)
        if (project.name.endsWith(".compat") || config.targetPlatform.eclipseVersion in ['43', '44', '45', '46', '47', '48', '49', '410', '411', '412', '413', '414', '415', '416']) {
            java {
                toolchain {
                    languageVersion = JavaLanguageVersion.of(8)
                }
            }
        } else {
            java {
                toolchain {
                    languageVersion = JavaLanguageVersion.of(11)
                }
            }
        }

        tasks.matching { it instanceof JavaCompile || it instanceof GroovyCompile }.all {
            // enable all warnings except for different sourceCompatibility and targetCompatibility value
            options.compilerArgs << '-Xlint:all'
            options.compilerArgs << '-Xlint:-options'
        }
    }

    // use common bundled testing depenendencies for all test plugins
    plugins.withType(eclipsebuild.TestBundlePlugin) {
        dependencies {
            implementation "org.codehaus.groovy:groovy-all:$groovyLibVersion"
            bundled "org.codehaus.groovy:groovy-all:$groovyLibVersion"
            bundled "org.objenesis:objenesis:$objenesisLibVersion"
            bundled "org.spockframework:spock-core:$spockLibVersion"
            bundled "cglib:cglib-nodep:$cglibLibVersion"
            bundled "org.slf4j:slf4j-simple:$slf4jLibVersion"
        }
        if (project.hasProperty('eclipse.test.java.version')) {
            tasks.withType(EclipseTestTask) {
                javaLauncher = javaToolchains.launcherFor {
                    languageVersion = JavaLanguageVersion.of(project.getProperty('eclipse.test.java.version') as Integer)
                }
            }
        }
    }

    // apply Checkstyle plugin, mainly to ensure license/copyright and javadoc is present
    apply plugin: 'checkstyle'

    // share checkstyle config across all sub-projects
    def checkstyleConfigDir = "$rootDir/gradle/config/checkstyle"
    tasks.withType(Checkstyle).all {
      configFile = "$checkstyleConfigDir/checkstyle.xml" as File
      configProperties = ['checkstyleConfigDir': checkstyleConfigDir]
      inputs.file "$checkstyleConfigDir/suppressions.xml" as File
    }

    tasks.withType(Test).all {
        def java8 = javaToolchains.launcherFor { languageVersion = JavaLanguageVersion.of(8) }
        def java11 = javaToolchains.launcherFor { languageVersion = JavaLanguageVersion.of(11) }
        jvmArgs "-Djdk8.location=${java8.get().metadata.installationPath.asFile}"
        jvmArgs "-Djdk11.location=${java11.get().metadata.installationPath.asFile}"

        // TODO re-enable html test reporting on Windows
        if (org.gradle.internal.os.OperatingSystem.current().windows) {
            reports.html.enabled = false
        }
    }

    // configure the repositories where the external dependencies can be found
    repositories {
        maven {
            name = 'mavenized-target-platform'
            url "${eclipsebuild.Config.on(project).mavenizedTargetPlatformDir}"
        }

        maven {
            name = 'gradle-snapshots'
            url gradleSnapshotsRepositoryUrl
        }

        maven {
            name = 'gradle-releases'
            url gradleReleasesRepositoryUrl
        }

        maven {
            name = 'gradle-remote'
            url gradleRemoteRepositoryUrl
        }
        mavenCentral()
    }    
}

// tag the HEAD of the current branch and push the new tag
task tag {
  doLast {
     def githubAccessKey = findProperty("githubAccessKey")
     if (!githubAccessKey) {
         throw new IllegalStateException("Cannot tag commit: define GitHub access key with -PgithubAccessKey=<access_key> project property")
     } else {
         // set access token
         System.setProperty("org.ajoberstar.grgit.auth.username", githubAccessKey)
         // tag current state
         grgit.tag.add {
           def tagVersion = file('version.txt').text.trim()
           name =  "REL_$tagVersion"
           message = "Create tag REL_$tagVersion"
         }
         // push changes
         grgit.push(tags: true)
     }
  }
}

// increment the service segment in the version number and push it to master
task incrementVersion {
    doLast {
        def oldVersion = file('version.txt').text.trim()
        def newVersion = ""
        def matcher = version =~ "^(\\d+)\\.(\\d+).(\\d+)"
        if (matcher.find()) {
            def serviceSegment = Integer.parseInt(matcher.group(3)) + 1
            newVersion = matcher.group(1) + "." + matcher.group(2) + "." + serviceSegment
            file('version.txt').text = newVersion
    
            Pattern bundleVersionPattern = Pattern.compile('(?<=Bundle-Version: )\\d+\\.\\d+\\.\\d+(?=\\.qualifier)')
            file('.').eachFileRecurse { file ->
                if(file.name == 'MANIFEST.MF') {
                    replacePatternsInFile(file, [(bundleVersionPattern) : newVersion])
                }
            }
        } else {
            throw new IllegalStateException("Unparseable version: $oldVersion.")
        }
        exec { commandLine 'git', 'commit', '-a', '-m', "Increment version from $oldVersion to $newVersion" }
        exec { commandLine 'git', 'push', githubAuthenticatedHost, 'master' }
    }
}

void replacePatternsInFile(File file, Map<Pattern, String> patternAndReplacement) {
    String fileText = file.text
    patternAndReplacement.each { Pattern pattern, String replacement ->
        fileText = pattern.matcher(fileText).replaceAll(replacement)
    }
    file.text = fileText
}

String getVersionQualifier() {
    def config = BuildshipConfig.on(project)

    // determine suffix for snapshot and milestone builds
    def suffix
    if (config.isRelease()) {
        suffix = ''
    } else if (config.isMilestone()) {
        suffix = '-m'
    } else if (config.isSnapshot()) {
        suffix = '-s'
    } else {
        throw new IllegalStateException("BuildshipConfig must either be a release, milestone, or snapshot.")
    }

    // use full timestamp on CI vs. date-only for local builds
    if (project.hasProperty('build.invoker') && project.property('build.invoker') == 'ci') {
        // note that for Eclipse plugin versions, the '-' and '.' character are invalid in front of the build id
        'v' + new Date().format('yyyyMMdd-kkmm', TimeZone.getTimeZone('GMT')) + suffix
    } else {
        'v' + new Date().format('yyyyMMdd', TimeZone.getTimeZone('GMT')) + suffix
    }
}

String getBundleVersion(String version) {
  def matcher = version =~ /(\d+)\.(\d+)(?:-.*|\.(\d+)(?:-.*)?)?/
  if (matcher.matches()) {
    def major = matcher.group(1)
    def minor = matcher.group(2)
    def service = matcher.group(3) ?: '0'
    return "$major.$minor.$service"
  } else {
    throw new IllegalArgumentException("Invalid bundle version: $version")
  }
}

def currentCommitId() {
    def result = new ByteArrayOutputStream()
    exec {
        standardOutput = result
        commandLine('git', 'rev-parse', '--verify', 'HEAD')
    }
    return result.toString().trim()
}
